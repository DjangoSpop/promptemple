<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Research Agent Test - PromptCraft</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .back-link { color: white; text-decoration: none; display: inline-block; margin-bottom: 20px; font-weight: 600; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 { color: #667eea; margin-bottom: 10px; font-size: 2.2em; }
        h2 { color: #667eea; margin-bottom: 15px; font-size: 1.6em; }
        .subtitle { color: #666; margin-bottom: 25px; line-height: 1.6; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1em; transition: border-color 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        
        .button-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-primary:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-secondary { background: #e2e8f0; color: #333; }
        .btn-secondary:hover { background: #cbd5e0; }
        .btn-danger { background: #ef4444; color: white; }
        
        .status { padding: 12px; border-radius: 6px; margin-bottom: 20px; font-weight: 600; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.streaming { background: #fef3c7; color: #92400e; }
        
        .progress-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .phase-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .phase-step {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e2e8f0;
        }
        
        .phase-step.active { border-left-color: #667eea; background: #f0f4ff; }
        .phase-step.complete { border-left-color: #10b981; }
        .phase-step.error { border-left-color: #ef4444; }
        
        .phase-step .phase-name { font-weight: bold; margin-bottom: 5px; color: #333; }
        .phase-step .phase-detail { font-size: 0.9em; color: #666; }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .metric-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-box .label { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .metric-box .value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        
        .answer-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            margin-top: 20px;
        }
        
        .answer-box h3 { color: #333; margin-bottom: 15px; }
        .answer-box .content { color: #333; line-height: 1.8; white-space: pre-wrap; }
        
        .sources-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .source-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .source-card h4 { color: #333; margin-bottom: 10px; font-size: 1.1em; }
        .source-card .url {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            word-break: break-all;
            display: block;
            margin-bottom: 10px;
        }
        
        .source-card .score {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        
        .source-card .snippet { color: #666; font-size: 0.9em; line-height: 1.5; }
        
        .logs {
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #334155;
        }
        
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #94a3b8; }
        .log-level-info { color: #60a5fa; }
        .log-level-success { color: #34d399; }
        .log-level-error { color: #f87171; }
        .log-level-progress { color: #fbbf24; }
        
        .streaming-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        @media (max-width: 768px) {
            .phase-steps { grid-template-columns: 1fr; }
            .sources-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/ai-test/" class="back-link">‚Üê Back to Dashboard</a>
        
        <div class="card">
            <h1>üî¨ Professional Research Agent Test</h1>
            <p class="subtitle">
                Advanced research pipeline with Tavily search, content extraction, chunking, embedding, 
                vector retrieval, and AI synthesis. Features real-time SSE streaming with job progress tracking.
            </p>
            
            <div class="form-group">
                <label for="query">Research Query</label>
                <textarea id="query" placeholder="Enter your research question... (e.g., What are the latest advancements in quantum computing?)"></textarea>
            </div>
            
            <div class="form-group">
                <label for="top-k">Number of Sources</label>
                <select id="top-k">
                    <option value="3">3 sources (Fast)</option>
                    <option value="6" selected>6 sources (Balanced)</option>
                    <option value="10">10 sources (Comprehensive)</option>
                </select>
            </div>
            
            <div class="button-group">
                <button class="btn-primary" id="start-btn" onclick="startResearch()">
                    üöÄ Start Research
                </button>
                <button class="btn-danger" id="stop-btn" onclick="stopStream()" style="display: none;">
                    ‚èπÔ∏è Stop Stream
                </button>
                <button class="btn-secondary" onclick="clearResults()">
                    üóëÔ∏è Clear Results
                </button>
            </div>
            
            <div id="status-container"></div>
        </div>
        
        <div class="card">
            <h2>üìä Research Metrics</h2>
            <div class="metrics">
                <div class="metric-box">
                    <div class="label">Job ID</div>
                    <div class="value" id="job-id" style="font-size: 0.9em;">-</div>
                </div>
                <div class="metric-box">
                    <div class="label">Status</div>
                    <div class="value" id="job-status">Idle</div>
                </div>
                <div class="metric-box">
                    <div class="label">Sources Found</div>
                    <div class="value" id="sources-count">0</div>
                </div>
                <div class="metric-box">
                    <div class="label">Chunks Created</div>
                    <div class="value" id="chunks-count">0</div>
                </div>
                <div class="metric-box">
                    <div class="label">Elapsed Time</div>
                    <div class="value" id="elapsed-time">0s</div>
                </div>
            </div>
        </div>
        
        <div class="card" id="progress-card" style="display: none;">
            <h2>‚öôÔ∏è Research Pipeline Progress</h2>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
                </div>
                
                <div class="phase-steps" id="phase-steps">
                    <div class="phase-step" id="phase-search">
                        <div class="phase-name">üîç Search</div>
                        <div class="phase-detail">Web search with Tavily</div>
                    </div>
                    <div class="phase-step" id="phase-fetch">
                        <div class="phase-name">üì• Fetch</div>
                        <div class="phase-detail">Extract content</div>
                    </div>
                    <div class="phase-step" id="phase-chunk">
                        <div class="phase-name">‚úÇÔ∏è Chunk</div>
                        <div class="phase-detail">Split into pieces</div>
                    </div>
                    <div class="phase-step" id="phase-embed">
                        <div class="phase-name">üß¨ Embed</div>
                        <div class="phase-detail">Generate vectors</div>
                    </div>
                    <div class="phase-step" id="phase-retrieve">
                        <div class="phase-name">üéØ Retrieve</div>
                        <div class="phase-detail">Find relevant chunks</div>
                    </div>
                    <div class="phase-step" id="phase-synthesize">
                        <div class="phase-name">‚ú® Synthesize</div>
                        <div class="phase-detail">Generate answer</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card" id="answer-card" style="display: none;">
            <h2>üìù Research Answer</h2>
            <div class="answer-box">
                <h3>Synthesized Answer:</h3>
                <div class="content" id="answer-content"></div>
            </div>
        </div>
        
        <div class="card" id="sources-card" style="display: none;">
            <h2>üìö Source Documents</h2>
            <div class="sources-list" id="sources-list"></div>
        </div>
        
        <div class="card">
            <h2>üìú Event Logs</h2>
            <div class="logs" id="logs"></div>
        </div>
    </div>
    
    <script>
        let eventSource = null;
        let startTime = null;
        let intervalId = null;
        let currentJobId = null;
        
        function addLog(message, level = 'info') {
            const logsContainer = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="log-level-${level}">${message}</span>`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            document.getElementById('status-container').innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateMetric(metricId, value) {
            document.getElementById(metricId).textContent = value;
        }
        
        function updateProgress(progress) {
            const percent = Math.round(progress * 100);
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = `${percent}%`;
            progressFill.textContent = `${percent}%`;
        }
        
        function updatePhase(phase, status) {
            const phaseEl = document.getElementById(`phase-${phase}`);
            if (phaseEl) {
                phaseEl.className = `phase-step ${status}`;
            }
        }
        
        async function startResearch() {
            const query = document.getElementById('query').value.trim();
            const topK = parseInt(document.getElementById('top-k').value);
            
            if (!query) {
                updateStatus('‚ö†Ô∏è Please enter a research query', 'error');
                addLog('Error: No query provided', 'error');
                return;
            }
            
            // Reset UI
            clearResults();
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').style.display = 'inline-block';
            document.getElementById('progress-card').style.display = 'block';
            updateStatus('<span class="streaming-indicator"></span> Starting research job...', 'streaming');
            updateMetric('job-status', 'Starting...');
            startTime = Date.now();
            
            // Start elapsed time counter
            intervalId = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                updateMetric('elapsed-time', `${elapsed}s`);
            }, 100);
            
            addLog('Initiating research request', 'info');
            addLog(`Query: ${query}`, 'info');
            addLog(`Top K: ${topK}`, 'info');
            
            try {
                // Create research job
                const response = await fetch('{{ api_base_url }}/api/v2/research/quick/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query, top_k: topK })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(`HTTP ${response.status}: ${errorData.error || errorData.detail || 'Request failed'}`);
                }
                
                const result = await response.json();
                currentJobId = result.job_id;
                
                updateMetric('job-id', currentJobId.substring(0, 8) + '...');
                addLog(`‚úÖ Job created: ${currentJobId}`, 'success');
                addLog(`Stream URL: ${result.stream_url}`, 'info');
                
                // Connect to SSE stream
                connectToStream(currentJobId);
                
            } catch (error) {
                clearInterval(intervalId);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
                updateMetric('job-status', 'Failed');
                addLog(`‚ùå Error: ${error.message}`, 'error');
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').style.display = 'none';
                console.error(error);
            }
        }
        
        function connectToStream(jobId) {
            addLog('üì° Connecting to SSE stream...', 'info');
            
            eventSource = new EventSource(`{{ api_base_url }}/api/v2/research/jobs/${jobId}/stream/`);
            
            eventSource.addEventListener('stream_start', (e) => {
                const data = JSON.parse(e.data);
                addLog('‚úÖ Stream connected', 'success');
                updateMetric('job-status', 'Running');
            });
            
            eventSource.addEventListener('progress', (e) => {
                const data = JSON.parse(e.data);
                addLog(`Progress: ${data.current_phase || 'processing'}`, 'progress');
                
                if (data.progress !== undefined) {
                    updateProgress(data.progress);
                }
                
                if (data.current_phase) {
                    updatePhase(data.current_phase, 'active');
                    updateMetric('job-status', data.current_phase);
                }
                
                if (data.docs_fetched) updateMetric('sources-count', data.docs_fetched);
                if (data.chunks_created) updateMetric('chunks-count', data.chunks_created);
            });
            
            eventSource.addEventListener('answer', (e) => {
                const data = JSON.parse(e.data);
                addLog('‚ú® Answer received', 'success');
                
                document.getElementById('answer-content').textContent = data.answer || data.text || 'No answer generated';
                document.getElementById('answer-card').style.display = 'block';
                
                // Display sources
                if (data.sources) {
                    displaySources(data.sources);
                }
            });
            
            eventSource.addEventListener('complete', (e) => {
                addLog('‚úÖ Research completed successfully', 'success');
                updateStatus('‚úÖ Research completed successfully', 'success');
                updateMetric('job-status', 'Complete');
                updateProgress(1);
                closeStream();
            });
            
            eventSource.addEventListener('error', (e) => {
                let errorMsg = 'Stream error occurred';
                try {
                    const data = JSON.parse(e.data);
                    errorMsg = data.message || errorMsg;
                } catch {}
                
                addLog(`‚ùå ${errorMsg}`, 'error');
                updateStatus(`‚ùå ${errorMsg}`, 'error');
                updateMetric('job-status', 'Error');
                closeStream();
            });
            
            eventSource.onerror = (error) => {
                addLog('‚ùå Stream connection error', 'error');
                updateStatus('‚ùå Stream connection lost', 'error');
                closeStream();
            };
        }
        
        function displaySources(sources) {
            const sourcesList = document.getElementById('sources-list');
            sourcesList.innerHTML = '';
            
            sources.forEach((source, idx) => {
                const sourceCard = document.createElement('div');
                sourceCard.className = 'source-card';
                sourceCard.innerHTML = `
                    <h4>Source #${idx + 1}</h4>
                    ${source.url ? `<a href="${source.url}" target="_blank" class="url">${source.url}</a>` : ''}
                    ${source.score ? `<span class="score">Relevance: ${source.score.toFixed(3)}</span>` : ''}
                    <div class="snippet">${source.content || source.text || source.snippet || 'No content available'}</div>
                `;
                sourcesList.appendChild(sourceCard);
            });
            
            document.getElementById('sources-card').style.display = 'block';
        }
        
        function stopStream() {
            addLog('‚èπÔ∏è Stopping stream...', 'info');
            closeStream();
            updateStatus('‚èπÔ∏è Stream stopped by user', 'error');
            updateMetric('job-status', 'Stopped');
        }
        
        function closeStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').style.display = 'none';
        }
        
        function clearResults() {
            document.getElementById('progress-card').style.display = 'none';
            document.getElementById('answer-card').style.display = 'none';
            document.getElementById('sources-card').style.display = 'none';
            document.getElementById('logs').innerHTML = '';
            document.getElementById('status-container').innerHTML = '';
            
            updateMetric('job-id', '-');
            updateMetric('job-status', 'Idle');
            updateMetric('sources-count', '0');
            updateMetric('chunks-count', '0');
            updateMetric('elapsed-time', '0s');
            updateProgress(0);
            
            // Reset phase steps
            ['search', 'fetch', 'chunk', 'embed', 'retrieve', 'synthesize'].forEach(phase => {
                updatePhase(phase, '');
            });
            
            addLog('Results cleared', 'info');
        }
        
        // Initialize
        addLog('Professional Research Agent initialized', 'success');
        addLog('API Base: {{ api_base_url }}', 'info');
        addLog('Endpoint: /api/v2/research/quick/', 'info');
    </script>
</body>
</html>
